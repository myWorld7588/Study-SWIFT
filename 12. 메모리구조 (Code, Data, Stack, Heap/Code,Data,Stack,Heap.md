# 1. 메모리 구조

프로그램이 실행되면 **운영체제(OS)는 메모리(RAM)에 이 프로그램을 위한 공간을 할당**해 줌 근데 그 공간은 다음과 같이 총 **4가지** 으로 나뉘어져 있음

# 1-1. Code 영역

- **Code: 사람이 작성한 소스코드가 기계어 형태로 저장된다.  컴파일 타임에 결정되고, 중간에 코드가 변경되지 않도록 Read-Only 형태로 저장된다.**

# 1-2. Data 영역

- **Data: 전역변수, static변수가 저장된다.  프로그램 시작과 동시에 할당되고, 프로그램이 종료 되어야 메모리가 해제된다.  실행도중 변수 값이 변경될 수 있으니 Read-Write 으로 지정된다.**

```swift
struct Korean {
    static let country = "Korea"       // 스태틱 변수(상수 로 데이터 영역에 할당
}

var name: String?                      // 전역 변수로 데이터 영역에 할당
var age: Int?                          // 전역 변수로 데이터 영역에 할당

func fetchData() {
}

```

name과 age는 **전역 변수**로, country는 **static 상수**로, 데이터 영역에 할당됨!

# 1-3. Heap 영역

- **Heap: 프로그래머가 할당/해제 하는 메모리 영역.  프로그래머는 malloc, calloc 으로 힙에 메모리를 할당할 수 있으며 이를 ‘동적 할당’ 이라고 한다.  사용하고 난 후에는 반드시 메모리 해제를 해줘야한다, 그렇지 않으면 memory leak이 발생.  Code, Data, Stack중 유일하게 런타임 시에 결정되기 때문에 데이터의 크기가 확실하지 않을때 사용한다.**

**그만큼 중요하다!!!** 위 정의에서 malloc, calloc으로 힙에 메모리를 할당한다고 했는데, 스위프트에선 위 함수들을 통해 직접 할당할 일이 별로 없어서 친근하지 않을 수 있음 하지만 스위프트에서 우린 언제나 어디서나 힙에 할당하고 있었음!! 언제? **클래스 인스턴스(Class Instance), 클로저 같은 참조 타입의 값** 들은 통해!! 이들은 모두 **힙에 자동 할당** 됨!!

또한 위에서 힙 특징으로 **힙을 사용하고 나면 반드시 "메모리 해제"를 해줘야 한댔음**

근데 우린 지금껏 스위프트를 사용하면서 클래스 인스턴스 맘대로 생성해서 쓰고 난 뒤에 메모리 해제를 해주는 작업을 안 해왔단 말임!?

인스턴스 다 쓰고 free, release 같은 거 해준 적 없잖음!! 왜냐 ㅎㅎㅎ?

**스위프트는 ARC를 통해 힙에 할당된 메모리가 더 이상 쓸모 없어지면(참조되지 않으면) 자동으로 해제해주기 때문이다..!** 지금은 이해 못 함! 그러나 이것에 대해 공부하기 위해 지금 이 메모리 영역에 대해 공부하는 것임!!

힙의 특징에 대해 알아보았으니 그에 따른 장점 단점은 다음과 같다

**// 명확한 단점은 속도.. 그런데 엄청 막 느린게 아니라 스택보다 상대적으로 느리단 개념임 //**

## 장점

- **메모리크기**에 대한 **제한없슴**
- 본직적인 범위가 전역이기 때문에, **프로그램의 모든 함수에서 엑세스** 할 수 있슴

## 단점

- 할당작업, 해제 작업으로 인한 **속도 저하**
- 힙 손상 (이중 해제, 해제 후 사용 등) 작업으로 인한 **속도 저하**
- 힙 경합( 두 개 이상 쓰레드가 동시에 접근하여 할 때 Lock이 걸림)으로 인한 **속도 저하**
- 메모리를 **직접 관리**해야 함 (헤제해주지 않을 시 메모리 누수 발생)

<br>

# 1-4. Stack 영역

- **Stack: 함수 호출 시 함수의 지역변수, 매개변수, 리턴 값 등등이 저장되고, 함수가 종료되면 저장된 메모리도 해제된다.  컴파일 타임에 결정되기 때문에 무한히 할당할 수 없다.  스택Stack은 프로그램이 자동으로 사용하는 임시 메모리 영역이다.**

평상시에 우리가 아무렇지 않게 함수를 호출하면

```swift
func add(_ a: Int, _ b: Int) -> Int {    // 파라미터 a, b는 스택에 할당됨
    let result = a + b                   // 지역변수 result는 스택에 할당됨
    return result
}
```

OS는 내부적으로 함수 안에 선언된 파라미터, 지역변수 등을 스택에 할당함.

그리고 위 add 함수가 종료되는 시점에 스택에 저장된 메모리는 알아서 모두 변환됨

또한 스택은 우리가 자료구조에서 배운 것 그대로 

**“LIFO” (Last in, First Out) 데이터 구조이고 (먼저 생성된 변수가 가장 나중에 해제됨)** 

CPU에 의해 관리되고 최적화 돼서 속도가 매우 빠름!!

스택에 대한 장, 단점을 정리하면 다음과 같다

**// 메모리를 무한히 할당할 수 없는 것이 가장 큰 단점 //**

## 장점

- CPU가 스택 메모리를 효율적으로 구성하기 때문에 **속도가 매우 빠름**
- 메모리를 **직접 해제를 해주지 않아도 됨**

## 단점

- **메모리 크기**에 대한 **제한이 있슴**
- **지역 변수만 액세스** 가능

</br>


# 2. Heap vs Stack

</br>

# 2-1. 언제 힙을 쓰고, 언제 스택을 쓸까?

위에서 나열한 장, 단점을 보면 알 수 있다.  스택은 메모리가 한정되어 있기 때문에 너무 큰 메모리는 할당할 수 없음 때문에 **데이터의 크기를 모르거나, 스택에 저장하기엔 큰 데이터의 경우엔 힙에 할당** 하고 그 외엔 스택에 할당하면 됨 (인스턴스, 클로저 등 자동으로 힙에 할당되는 것 외에 직접 할당할 경우!)

만약 스택에 너무 많은 메모리를 할당하게 어떻게 되나면 스택 오버 플로우 가 발생함. 

## 스택 오버 플로우 Stack Over Flow 란?

**스택에 너무 많은 메모리를 할당하게 되어 자신의 스택 영역을 초과한 경우** 를 뜻함

iOS 에서 스택 오버 플로우 발생 시 어플이 죽어버리니까 조심해야한다.  

</br>


# 2-2. 힙과 스택의 메모리 관계

지금껏 위에서 힙과 스택을 나누어서 설명했지만, 사실 힙과 스택은 **같은 메모리 영역을 공유함.**

같은 메모리 공간이지만, **힙 영역은 낮은 메모리 주소부터 할당 받는 것이고**,

**스택 영엽은 높은 메모리 주소부터 할당 받는 것이다.**


따라서 힙 또한 잔신의 영역 외로 확장하려다 보면, **힙 오버 플로우** 라는 것이 발생한다.
